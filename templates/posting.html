<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>인원모집 페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>
    <style>
        .top {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
        .login {
            justify-content: right;
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .back-btn {
            justify-content: left;

            margin-left: 10px;
            height: 50px;
            width: 150px;
            border-radius: 20px;

            background-color: transparent;
            border: 2px solid black;
        }
        .back-btn:hover {
            border: 3px solid black;
        }
        .wrap {
            height: 400px;
            width: 1000px;
            margin: auto;

            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .img-box {
            background-position: center;
            background-size: cover;
            height: 380px;
            width: 300px;
            margin-right: 5px;
            border-radius: 10px;
            border: 1px solid black;

            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;

        }
        .input-box {
            height: 380px;
            width: 680px;

            border-radius: 10px;
            border: 2px solid black;

            padding-top: 100px;

        }

        .input-g {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;

            margin-top: 10px;
            margin-bottom: 10px;
        }

        .card {
            max-width: 1200px;
            width: 95%;
            height: 300px;


            margin: 20px auto 0px auto;

            display: flex;
            flex-direction: row;
            justify-content: left;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .card-left {
            display: flex;
            flex-direction: column;
            justify-content: left;
            align-items: center;

            height: 300px;
        }

        .card-right {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;

            margin: auto;

            height: 300px;
        }

        .card-right > button {
            margin: 10px auto 10px auto;
            height: 100px;
            width: 160px;
        }

        .card-top {
            display: flex;
            flex-direction: row;
            justify-content: left;
            align-items: center;

            margin-top: 10px;
        }

        .Rname {
            width: 450px;
            height: 40px;
            margin-left: 20px;

            justify-content: center;
            display: flex;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .Uname {
            width: 450px;
            height: 40px;
            margin-left: 10px;

            justify-content: center;
            display: flex;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .card-bottom {
            display: flex;
            flex-direction: row;
            justify-content: left;
            align-items: center;

            position: absolute;
            bottom: 10px;
        }

        .time {
            width: 450px;
            height: 40px;
            margin-left: 20px;

            justify-content: center;
            display: flex;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .nums {
            width: 450px;
            height: 40px;
            margin-left: 10px;

            justify-content: center;
            display: flex;
            align-items: center;

            border-radius: 10px;
            border: 2px solid black;
        }

        .descript {
            height: 175px;
            width: 910px;
            margin-left: 20px;
            display: flex;
            justify-content: left;
            align-items: center;

            margin-top: 10px;

            border-radius: 10px;
            border: 2px solid black;
        }

    </style>
    <script>
        $(document).ready(function () {
            show_room()
        });

        function save_room() {
            let gname = $('#gname').text()
            let title = $('#gtitle').val()
            let desc = $('#desc').val()
            let totalnum = $('#totalnum').val()
            let ddate = $('#dday').val()
            let dtime = $('#dtime').val()
            let nick = $('#nick').text()

            $.ajax({
                type: 'POST',
                url: '/room',
                data: {gname_give: gname, title_give: title, desc_give: desc, totalnum_give: totalnum,
                 date_give: ddate, time_give: dtime, nick_give: nick},
                success: function (response) {
                    alert(response['msg'])
                    window.location.reload()
                }
            })
        }

        function show_room() {
            $('#main').empty()
            $.ajax({
                type: "GET",
                url: "/room",
                data: {},
                success: function (response) {
                    let rows = response['room']
                    let me = $('#nick').text()
                    let gn = $('#gname').text()
                    for (let i = 0; i < rows.length; i++) {
                        let gname = rows[i]['gname']
                        if (gn == gname) {
                            let rid = rows[i]['rid']
                            let title = rows[i]['title']
                            let desc = rows[i]['desc']
                            let totalnum = rows[i]['totalnum']
                            let num = rows[i]['num']
                            let ddate = rows[i]['date']
                            let dtime = rows[i]['time']
                            let nick = rows[i]['nick']
                            let party = rows[i]['participate']


                            let check = false
                            let dInfo = ddate.split('-')
                            let tInfo = dtime.split(':')

                            let nd = new Date()
                            let nInfo = []
                            nInfo.push(nd.getFullYear())
                            nInfo.push(nd.getMonth() + 1)
                            nInfo.push(nd.getDate())
                            nInfo.push(nd.getHours())
                            nInfo.push(nd.getMinutes())


                            if(dInfo[0] < nInfo[0]) check = false
                            else if(dInfo[0] > nInfo[0]) check = true
                            else{
                                if(dInfo[1] < nInfo[1]) check = false
                                else if(dInfo[1] > nInfo[1]) check = true
                                else{
                                    if(dInfo[2] < nInfo[2]) check = false
                                    else if(dInfo[2] > nInfo[2]) check = true
                                    else{
                                        if (tInfo[0] < nInfo[3]) check = false
                                        else if(tInfo[0] > nInfo[3]) check = true
                                        else{
                                            if (tInfo[1] < nInfo[4]) check = false
                                            else check = true
                                        }
                                    }
                                }
                            }

                            if (num < totalnum && check) check = true
                            else check = false


                            let temp_html = ``
                            if (!party.includes(me)){
                                if(check){
                                    temp_html = `<div class="card">
                                            <div class="card-left">
                                                <div class="card-top">
                                                    <div class="Rname">
                                                        <h4>${title}</h4>
                                                    </div>
                                                    <div class="Uname">
                                                        <h4><i>${nick}</i></h4>
                                                    </div>
                                                </div>
                                                <div class="descript">
                                                    <h5>${desc}</h5>
                                                </div>
                                                <div class="card-bottom">
                                                    <div class="time">
                                                        <h4>${ddate}/${dtime}</h4>
                                                    </div>
                                                    <div class="nums">
                                                        <h4>${num}/${totalnum}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-right">
                                                <button type="button" class="btn btn-outline-primary" onclick="checkfin(${rid})">참가하기</button>
                                                <button type="button" class="btn btn-outline-dark" onclick="showmember(${rid})">멤버보기</button>
                                            </div>
                                        </div>`
                                }
                                else{
                                        temp_html = `<div class="card">
                                            <div class="card-left">
                                                <div class="card-top">
                                                    <div class="Rname">
                                                        <h4>${title}</h4>
                                                    </div>
                                                    <div class="Uname">
                                                        <h4><i>${nick}</i></h4>
                                                    </div>
                                                </div>
                                                <div class="descript">
                                                    <h5>${desc}</h5>
                                                </div>
                                                <div class="card-bottom">
                                                    <div class="time">
                                                        <h4>${ddate}/${dtime}</h4>
                                                    </div>
                                                    <div class="nums" style="border-color:red">
                                                        <h4 style="color:red">마감</h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-right">
                                                <button type="button" class="btn btn-outline-primary" disabled>참가하기</button>
                                                <button type="button" class="btn btn-outline-dark" onclick="showmember(${rid})">멤버보기</button>
                                            </div>
                                        </div>`
                                }
                            }
                            else {
                                if(check){
                                    temp_html = `<div class="card">
                                            <div class="card-left">
                                                <div class="card-top">
                                                    <div class="Rname">
                                                        <h4>${title}</h4>
                                                    </div>
                                                    <div class="Uname">
                                                        <h4><i>${nick}</i></h4>
                                                    </div>
                                                </div>
                                                <div class="descript">
                                                    <h5>${desc}</h5>
                                                </div>
                                                <div class="card-bottom">
                                                    <div class="time">
                                                        <h4>${ddate}/${dtime}</h4>
                                                    </div>
                                                    <div class="nums">
                                                        <h4>${num}/${totalnum}</h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-right">
                                                <button type="button" class="btn btn-outline-danger" onclick="leave(${rid})">취소하기</button>
                                                <button type="button" class="btn btn-outline-dark" onclick="showmember(${rid})">멤버보기</button>
                                            </div>
                                        </div>`
                                }
                                else{
                                        temp_html = `<div class="card">
                                            <div class="card-left">
                                                <div class="card-top">
                                                    <div class="Rname">
                                                        <h4>${title}</h4>
                                                    </div>
                                                    <div class="Uname">
                                                        <h4><i>${nick}</i></h4>
                                                    </div>
                                                </div>
                                                <div class="descript">
                                                    <h5>${desc}</h5>
                                                </div>
                                                <div class="card-bottom">
                                                    <div class="time">
                                                        <h4>${ddate}/${dtime}</h4>
                                                    </div>
                                                    <div class="nums" style="border-color:red">
                                                        <h4 style="color:red">마감</h4>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-right">
                                                <button type="button" class="btn btn-outline-danger" onclick="leave(${rid})">취소하기</button>
                                                <button type="button" class="btn btn-outline-dark" onclick="showmember(${rid})">멤버보기</button>
                                            </div>
                                        </div>`
                                }

                            }
                            $('#main').append(temp_html)
                        }
                    }
                }
            });
        }

        function participate(id) {
            let nick = $('#nick').text()
            $.ajax({
                type: "POST",
                url: "/room/in",
                data: {rid_give: id, nick_give: nick},
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        function leave(id){
            let nick = $('#nick').text()
            $.ajax({
                type: "POST",
                url: "/room/out",
                data: {rid_give: id, nick_give: nick},
                success: function (response) {
                    alert(response["msg"])
                    window.location.reload()
                }
            });
        }

        function checkfin(id){
            let nd = new Date()
            $.ajax({
                type: "POST",
                url: "/room/check",
                data: {rid_give: id, y: nd.getFullYear(), m: nd.getMonth()+1, d: nd.getDate(),
                h: nd.getHours(), mi: nd.getMinutes()},
                success: function (response) {
                    if(response["check"]) participate(id)
                    else{
                        alert(response["msg"])
                        window.location.reload()
                    }
                }
            });
        }

        function showmember(id){
            $.ajax({
                type: "POST",
                url: "/room/showmember",
                data: {rid_give: id},
                success: function (response) {
                    let p = '참가자: ' + response["members"]
                    alert(p)
                }
            });
        }
    </script>
</head>
<body>
<div class="top">
    <button class="back-btn" onclick='window.location.href = "/gamelist"';>뒤로가기</button>
    <div class="login">
       <h1 id="nick">{{user_nick}}</h1>
        <h1>으로 접속중</h1>
    </div>
</div>

<div class="wrap">
    <div class="img-box" style="background-image:url({{ img_src }})">
    </div>
    <div class="input-box">
        <h2 id="gname" style="font-weight: bold; text-align: center" >{{game_name}}</h2>
        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">방 이름</span>
            <input type="text" class="form-control" aria-describedby="basic-addon1" id="gtitle">
        </div>
        <div class="input-group">
            <span class="input-group-text">본문</span>
            <textarea class="form-control" aria-label="With textarea" id="desc"></textarea>
        </div>
        <div class="input-g">
            <input type='date' id="dday">
            <input type='time' id="dtime">
            <input type='number' min='2' id="totalnum">
        </div>
        <div class="d-grid gap-2 col-6 mx-auto">
            <button class="btn btn-primary" type="button" onclick="save_room()">모집하기</button>
        </div>
    </div>
</div>

<div id="main">
<div class="card">
    <div class="card-left">
        <div class="card-top">
            <div class="Rname">
                <h4>게임방 이름</h4>
            </div>
            <div class="Uname">
                <h4><i>유저이름</i></h4>
            </div>
        </div>
        <div class="descript">
            <h5>본문내용</h5>
        </div>
        <div class="card-bottom">
            <div class="time">
                <h4>2022.07.11. / 17:11</h4>
            </div>
            <div class="nums">
                <h4>5/8</h4>
            </div>
        </div>
    </div>
    <div class="card-right">
        <button type="button" class="btn btn-outline-primary">참가하기</button>
        <button type="button" class="btn btn-outline-dark">멤버보기</button>
    </div>
</div>
<div class="card">
    <div class="card-left">
        <div class="card-top">
            <div class="Rname">
                <h4>게임방 이름</h4>
            </div>
            <div class="Uname">
                <h4><i>유저이름</i></h4>
            </div>
        </div>
        <div class="descript">
            <h5>본문내용</h5>
        </div>
        <div class="card-bottom">
            <div class="time">
                <h4>2022.07.11. / 17:11</h4>
            </div>
            <div class="nums" style="border-color:red">
                <h4 style="color:red">마감</h4>
            </div>
        </div>
    </div>
    <div class="card-right">
        <button type="button" class="btn btn-outline-danger">취소하기</button>
        <button type="button" class="btn btn-outline-dark">멤버보기</button>
    </div>
</div>
</div>

</body>
</html>